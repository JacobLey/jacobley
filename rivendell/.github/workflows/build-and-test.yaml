name: Build and Test

on:
  workflow_call:
    inputs:
      depth:
        type: number
        required: false
        default: 1
      base-ref:
        type: string
        required: false
      head-ref:
        type: string
        required: false

jobs:

  install-root:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/cache@v3
        id: cache-install
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      # If node_modules not built, install node and install
      - if: steps.cache-install.outputs.cache-hit != 'true'
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - if: steps.cache-install.outputs.cache-hit != 'true'
        run: npm ci -ws --include-workspace-root

      # We'll store all our outputted "builds" in a `./tarballs` directory
      # that only needs to live for the rest of the build + test
      - run: |
          mkdir tarballs
          tar -zcf ./tarballs/node_modules.tgz ./node_modules
      - uses: actions/upload-artifact@v3
        with:
          name: build
          path: ./tarballs/node_modules.tgz
          retention-days: 1

  root-test:
    needs: install-root
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - uses: actions/download-artifact@v3
        with:
          name: build
      - run: tar -xf ./tarballs/node_modules.tgz
      # Ensure symlinks are generated + root files are linted
      # Conceptually barrel + rivendell checks should go here... but files aren't built yet
      - run: |
          ./scripts/write-symlinks.mjs
          npm run lint:root

  # For each package (matrix.package) run lint tests
  package-lint:
    needs: install-root
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Rivendell will auto-expand to each package
        package: ${{{ rivendell.all-packages }}}
    steps:
      - uses: actions/checkout@v3
        with:
          # Should include depth on any jobs that will use `changed` command/logic
          # Not necessary for hash/dependencies only commands
          fetch-depth: ${{ inputs.depth }}
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - uses: actions/download-artifact@v3
        with:
          name: build

      # Only need to unpack node_modules (eslint executable + third party types).
      # Packages are being built, but package.json specifies to use original `.ts`
      # types over build `.d.ts` files, so everything that is required is already available.
      - run: tar -xf ./tarballs/node_modules.tgz

      # If a package has not changed since
      - name: Check if package has changes
        id: rivendell
        run: echo "::set-output name=changed::$(npx rivendell changed ${{ matrix.package.name }} ${{ inputs.base-ref }} ${{ inputs.head-ref }})"

      - if: steps.rivendell.outputs.changed == 'true'
        working-directory: ${{ matrix.package.path }}
        run: npm run lint

  # Rivendell will create N copies of job, that depend on the previous (as well as any other `needs`)
  # N is determined by the max `stage` determined by `dependency-order` package
  package-build-${{{ rivendell.stage }}}:
    needs: install-root
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Rivendell will populate matrix per-job with packages for that stage
        package: ${{{ rivendell.stage-packages }}}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16

      # Download _all_ builds up to this point
      - uses: actions/download-artifact@v3
        with:
          name: build
      # And only unpack node_modules for now
      - run: tar -xf ./tarballs/node_modules.tgz

      # Generate a hash that specifies "state" of package + dependencies
      - name: Calculate dependency hash
        id: rivendell
        run: echo "::set-output name=hash::$(npx rivendell hash ${{ matrix.package.name }})"

      # Try to load a previously cached version of build (determined by hash)
      - uses: actions/cache@v3
        id: hash-build
        with:
          path: ./tarballs/${{ matrix.package.safe-name }}.tgz
          key: ${{ runner.os }}-package-${{ matrix.package.name }}-${{ steps.rivendell.outputs.hash }}

      # If cache missed (no build) unpack the rest of builds (get built dependencies)
      - if: steps.hash-build.outputs.cache-hit != 'true'
        run: |
          for TARBALL in ./tarballs/*.tgz
            do
              # Can skip node_modules as already extracted
              if [ $TARBALL != "./tarballs/node_modules.tgz" ]
                then
                  tar -xf $TARBALL
              fi
            done

      # If cache missed (continued) build the package, and generate a pack (ensure respect .npmignore)
      - if: steps.hash-build.outputs.cache-hit != 'true'
        working-directory: ${{ matrix.package.path }}
        run: |
          npm run build:ci
          # Pack to get list of desired files
          cp ../../common/npm/.npmignore ./.npmignore
          npm pack

      # If cache missed (continued) copy packed files into tarball
      - if: steps.hash-build.outputs.cache-hit != 'true'
        run: |
          VERSION=$(npm exec -w=${{ matrix.package.name }} -c 'npm pkg --no-workspaces get version' | sed -e "s|\"||g")
          # List files in npm packed archive
          tar -tf "${{ matrix.package.path }}/${{ matrix.package.name }}-${VERSION}.tgz" \
            `# redirect package to file path` \
            sed -e "s|^package|${{ matrix.package.path }}|" | \
            `# pack new file based on list with proper paths` \
            tar -czf ./tarballs/${{ matrix.package.safe-name }}.tgz -T -

      # Upload tarball to build artifact (was either built in this run, or used cached version)
      - uses: actions/upload-artifact@v3
        with:
          name: build
          path: ./tarballs/${{ matrix.package.safe-name }}.tgz
          retention-days: 1

  # Split tests into stages, so a build's test will start immediately following build stage.
  # Tests only run when package has changed, else optimistically ends early (skips actual test)
  package-test-${{{ rivendell.stage }}}:
    needs:
      - package-build-${{{ rivendell.stage }}}
      - package-lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{{ rivendell.stage-packages }}}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: ${{ inputs.depth }}
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - uses: actions/download-artifact@v3
        with:
          name: build
      - run: tar -xf ./tarballs/node_modules.tgz

      - name: Check if package has changes
        run: echo "::set-output name=changed::$(npx rivendell changed ${{ matrix.package.name }} ${{ inputs.base-ref }} ${{ inputs.head-ref }})"
        id: rivendell

      # If package has experienced changes, extract all builds (guaranteed to contain package + dependencies)
      - if: steps.rivendell.outputs.changed == 'true'
        run: |
          for TARBALL in ./tarballs/*.tgz
            do
              if [ $TARBALL != "./tarballs/node_modules.tgz" ]
                then
                  tar -xf $TARBALL
              fi
            done

      # If package has experienced changes (continued), test package
      - if: steps.rivendell.outputs.changed == 'true'
        working-directory: ${{ matrix.package.path }}
        run: npm run test

  # Run some top-level tests once everything is built/tested
  # Ideally these tests occur at start of CI (root-test), but executables are not built yet...
  post-test:
    needs:
      - root-test
      # Ensures all packages are individually tested first
      # which implicitly requires all packages built
      - package-test-${{{ rivendell.max-stage }}}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: |
          for TARBALL in ./tarballs/*.tgz
            do
              tar -xf $TARBALL
            done

      - run: |
          npm run barrel:ci
          npm run rivendell:ci
